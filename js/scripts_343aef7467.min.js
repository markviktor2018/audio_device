Dropzone.autoDiscover=false;var form_redirects={success:'/viza-oplata-uspeshna',fail:'/viza-online',ret:'/viza-online',success_cour:'/viza-ozhidajte-kurera'};$(document).ready(function(){checkDiscounts();$.ajax({url:'/backend/ajax/get_viza_companies.php',dataType:'JSON'}).success(function(json){$('#calc__select-insurance--toggle').find('ul').html('');$.each(json.companies,function(k,v){var li=$('<li/>').data('value',v.company_name).html(v.company_name);if(parseInt(v.prices[30].price)>0){li.html(li.html()+' <b>+'+v.prices[30].price+' руб.</b>');}
$('#calc__select-insurance--toggle').find('ul').append(li);});});$('.discount_type input').change(function(){var selected=$('.discount_type input:checked').val();$('.discount_edit').slideUp();$('.discount_edit input[name="discount_data"]').prop('disabled',true);$('.discount_edit[data-type="'+selected+'"]').slideDown(400,function(){initSteps1();});$('.discount_edit[data-type="'+selected+'"] input[name="discount_data"]').prop('disabled',false);}).change();$('input[name="adults"],input[name="children"],input[name="children2"],input[name="elders"],input[name="elders2"]').change(function(e){var str='';var adults=$('input[name="adults"]').val()||0;var children=$('input[name="children"]').val()||0;var children2=$('input[name="children2"]').val()||0;var elders=$('input[name="elders"]').val()||0;var elders2=$('input[name="elders2"]').val()||0;if(adults>0){str+=adults+" взр.";}
if(children>0){if(str)str+=", ";str+=children+" дет.";}
if(children2>0){if(str)str+=", ";str+=children2+" дет.";}
if(elders>0){if(str)str+=", ";str+=elders+" пожил.";}
if(elders2>0){if(str)str+=", ";str+=elders2+" стар.";}
$('#calc__select-program-show').val(str);});$('#choice-viza_service_type input').on('change',function(){if($('#viza_service_type_1').is(':checked')){initSteps1();$('.visa-step3-description-full').show();$('.visa-step3-description-partial').hide();$('.delivery-show-type-2').hide();}else if($('#viza_service_type_2').is(':checked')){initSteps1();$('.visa-step3-description-partial').show();$('.visa-step3-description-full').hide();$('.delivery-show-type-2').show();}});$('#choice-viza_service_type input:checked').change();$('input[name="pickup_documents"]').change(function(){if($(this).is(':checked')){$('.pickup_documents_addr').slideDown();}
else{$('.pickup_documents_addr').slideUp();}});var check_delivery_same=function(){var send=parseInt($('input[name="send_document_type"]:checked').val())||0;var delivery=parseInt($('.visa3-delivery input[name=delivery_type]:checked').val())||0;if(send===delivery&&send===2){$('.send_delivery_address').hide();$('.send_delivery_office').show();}
else{$('.send_delivery_address').show();$('.send_delivery_office').hide();}
if(send==2||delivery==2){$('.office_maps').show();}
else{$('.office_maps').hide();}};var change_office=function(){};$('.select-office li').click(function(){var office=$(this).data('id');var coords=getOfficesCoords()[office-1];myMap.setZoom(11);myMap.setCenter(coords.geometry.getCoordinates());});$('.visa3-delivery input[name="delivery_type"]').change(function(){$('.delivery_contact_email').html($('input[name="contact_email"]').val());$('.delivery_document_field').hide();$('.delivery_document_field[data-type="'+$(this).val()+'"]').show();$('#pay-switcher').siblings('div').find('span.no').html('Оплата курьеру');if($('#pay-switcher').val()=='Оплата в офисе'){$('#pay-switcher').val('Оплата курьеру');}
if($('#pay-switcher').val()=='Онлайн-оплата'){$('#calc__form__submit--step3').html('ПЕРЕЙТИ К ОПЛАТЕ');}else{$('#calc__form__submit--step3').html('ЗАКАЗАТЬ');}
check_delivery_same();});$('input[name="send_document_type"]').change(function(){$('.send_document_field').hide();$('.send_document_field[data-type="'+$(this).val()+'"]').show();check_delivery_same();});$('.visa3-delivery input[name="delivery_type"]:checked').change();$('input[name="send_document_type"]:checked').change();$('#calc__select-location--toggle').click(function(e){$('#calc__select-location__input').val('');if($('#calc__select-location__input').data('autocomplete')===undefined){$.ajax({url:'/backend/ajax/countries.php',type:'GET',data:{regionCode:selected_country},dataType:'json',async:false,success:function(result){$('#calc__select-location__input').autocomplete({lookup:result,onSelect:function(suggestion){$('#calc__select-location--toggle input').val(suggestion.value);$('input[name="country"]').val(suggestion.data).data('location-country',suggestion.data).change();$('#calc__select-location').removeClass('active');if(true||suggestion.value=='Финляндия'||suggestion.value=='Литва'){$('#viza_service_type_1').parent().show();}else{$('#viza_service_type_1').parent().hide();$('#viza_service_type_2').click();}
var countryname=suggestion.value;$('label[for="podacha_office_1"] span').text(suggestion.vc);$('label[for="podacha_office_2"] span').text(suggestion.vc);$('.viza-form-warning').hide();$('.viza-form-warning[data-country="'+suggestion.data+'"]').show();if(suggestion.value=='США'||suggestion.value=='Великобритания'||suggestion.value=='Литва'){$('label[for="podacha_office_1"]').parent().hide();$('label[for="podacha_office_2"]').click();}else{$('label[for="podacha_office_1"]').parent().show();}}});var hrefs=calc__location_get_random_hrefs(result.slice(0),result.length,false);$('#calculator__form__dropdown__help-location__input').html('Например '+hrefs);$('.calculator__form__dropdown__help a').click(function(e){var get_val=$(this).data('value');$('#calc__select-location__input').val($(this).text());$('#calc__select-location__input').autocomplete().getSuggestions($(this).text());$('#calc__select-location__input').autocomplete().select(0);e.stopPropagation();});}})}
$('.select-country').click(function(){var countryId=$(this).data('countryId');console.log($(this),countryId);$('#calculator__form__dropdown__help-location__input').find('[data-value="'+countryId+'"]').click();});$(this).toggleClass('active');$('#calc__select-location').toggleClass('active');e.stopPropagation();});$('input[name="strah_company"],input[name="days"],input[name="adults"],input[name="children"],input[name="children2"],input[name="elders"],input[name="elders2"],input[name="country"],input[name="viza_service_type"],input[name="country"],input[name="podacha"],input[name="send_document_type"],input[name="delivery_type"],input[name=promo],input[name="pickup_documents"],input[name="discount_type"],input[name="discount_data"]').change(function(){initSteps1();checkDiscounts();viza_calc_summ();});$('#calc__form__submit--step1').bindFirst('click',function(e){e.preventDefault();if(validateStep1()){initSteps2();generate_visa_tabs();init_visa_events();initDatePickers();initMasks();$('.visa2__uploader-head .ico-tooltip').tooltip();$('.visa__tab').eq(0).click();}else{e.stopImmediatePropagation();}});$('#calc__form__submit--step2').bindFirst('click',function(e){e.preventDefault();if(validateStep2()){prepopulateStep3();}else{e.stopImmediatePropagation();}});$('#calc__form__submit--step3').bindFirst('click',function(e){e.preventDefault();if(validateStep3()){var form1=serializeFormWithoutDisabled('#calc__form__step1');var form2=serializeForm('#calc__form__step2');var form3=serializeForm('#calc__form__step3');data=form1+"&"+form2+"&"+form3;polis_submit_form('viza',data,form_redirects);}});$('input[name="country"],input[name="podacha"],input[name="viza_service_type"]').change(function(){var p=$('input[name="podacha"]:checked').val();var d=$('input[name="viza_service_type"]:checked').val();var country=$('input[name="country_name"]').val();var time_period='с 8:00 до 16:00';if(d==2&&p==4){$('.consul_time_note').show();}else{$('.consul_time_note').hide();}
if(d==2){time_period='с 8:00 до 15:45';}
if(d==1){if(country=='Финляндия')time_period="с 13:00 до 15:45";if(country=='Литва')time_period="с 9:00 до 10:00";if(country=='Италия')time_period="с 16:00 до 19:00";}
$('input[name="date_vc_hours"]').val(time_period).parent().removeClass('toggable-list-dropdown').removeClass('input--dropdown');});var initvars=['country','viza_service_type','podacha','strah_company','days','adults','children','children2','elders','elders2'];for(i in initvars){var param=getUrlParameter(initvars[i]);var property=initvars[i];if(param){$('select[name="'+property+'"][value="'+param+'"]').attr('selected','selected').change();$("input[name='"+property+"'][value='"+param+"']").prop("checked",true).change();$('input[name="'+property+'"][type="text"]').val(param).change();$('input[name="'+property+'"][type="number"]').val(param).change();}}
initSteps1();$('#calc__form__back--step2').click(function(e){initSteps1();});var countries=[];var query_params=window.location.query();if(query_params.country){$.ajax({url:"/backend/ajax/countries.php",method:"GET",success:function(response){countries=JSON.parse(response);var value=query_params.country;for(var i=0;i<countries.length;i++){var item=countries[i];if(item.value==value){$('#calc__select-location--toggle').click();$('.calculator__form__dropdown__help a').each(function(k,v){if($(v).text()==value){$(v).click();return false;}});$('#calc__select-location--toggle').click();$('#calc__select-location--toggle').click();$("input[name=country_name]").val(value);$("input[name=country]").val(item.data);break;}}}});}});function checkDiscounts(){var adults=parseInt($('input[name="adults"]').val()||0);var children=parseInt($('input[name="children2"]').val()||0);var total=adults+children;var allowDiscount=[0,3,4,5];if(total>=3){allowDiscount.push(1);}
if(total>=5){allowDiscount.push(2);}
$('.discount_type').hide();$.each(allowDiscount,function(k,v){$('.discount_type[data-type="'+v+'"]').show();});}
function fixFileNumbers(){setTimeout(function(){$('.visa2__uploaders__wrap').each(function(index,el){var iconum=$(this).find('.visa2__uploader-head i.ico-num:visible');iconum.each(function(index,el){$(this).text(index+1);});});},100);}
function checkFileForms(){var country=$('input[name="country_name"]').val();if(country=='США'){$('.visa__helper a').attr('href','/spisok-dokumentov-usa.pdf').attr('target','_blank');$('.visa__helper').show();}else if(country=='Великобритания'){$('.visa__helper a').attr('href','/dokumenti_viza-uk.pdf').attr('target','_blank');$('.visa__helper').show();}else{$('.visa__helper').hide();}
$('.visa2__wrap').each(function(index,el){var occupation=$(this).find('input[name="occupation[]"]').val();var self_or_invite_travel=$(this).find('input[name="self_or_invite_travel[]"]').val();var visa_stay=$(this).find('input[name="visa_stay[]"]').val();var schengen_last_3_years=$(this).find('input[name="schengen_last_3_years[]"]').val();if(country=='Финляндия'||country=='США'||country=='Великобритания'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').hide();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').prev().hide();}else{$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').show();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').prev().show();}
if(country=='Финляндия'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').hide();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').prev().hide();}else{$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').show();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').prev().show();}
if(schengen_last_3_years=='Да'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_zagranviza[]"]').show();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_zagranviza[]"]').prev().show();}else{$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_zagranviza[]"]').hide();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_zagranviza[]"]').prev().hide();}
if(occupation!='Не работаю / не учусь'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').prev().html('<i class="ico ico-num"></i> Справка с места работы/учебы');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"] .dz-message span').html('Выберите файл со сканом справки с места работы/учебы');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').attr('title','Загрузите файл со справкой с места работы/учебы');}else{$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').prev().html('<i class="ico ico-num"></i> Справка о доходах');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"] .dz-message span').html('Выберите файл со сканом справки о доходах');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_work[]"]').attr('title','Загрузите файл со справкой о доходах');}
if(self_or_invite_travel=='Самостоятельно'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_invite[]"]').hide();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_invite[]"]').prev().hide();}else if(self_or_invite_travel=='По приглашению'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_invite[]"]').show();$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_invite[]"]').prev().show();}
if(visa_stay=='В отеле'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').prev().html('<i class="ico ico-num"></i> Бронь отеля');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"] .dz-message span').html('Выберите файл со сканом подтверждения брони');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').attr('title','Загрузите файл с бронью отеля');}else if(visa_stay=='Частная собственность'&&country!='Финляндия'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').prev().html('<i class="ico ico-num"></i> Документ на недвижимость');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"] .dz-message span').html('Выберите файл со сканом документа на недвижимость');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').attr('title','Загрузите файл со справкой документа на недвижимость');}else if(visa_stay=='Частная собственность'&&country=='Финляндия'){$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').prev().html('<i class="ico ico-num"></i> Справки о приглашающей стороне');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"] .dz-message span').html('Выберите файл со сканом документа на недвижимость и справки из налоговой');$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_hotel[]"]').attr('title','Загрузите файл со справкой документа на недвижимость и справки из налоговой');}});fixFileNumbers();}
function initSteps1(){$('.calculator__steps__step--3').hide();setTimeout(function(){$('.calculator__steps__step--2').css('margin-top',$('#calc__form__submit--step1').offset().top-$('.calculator__steps__step--1').offset().top-40);$('.calculator__steps__step--2').show();},20);}
function initSteps2(){$('.calculator__steps__step--2').css('margin-top','0px');setTimeout(function(){$('.calculator__steps__step--2').css('margin-top',$('#calc__form__step2__zayaviteli').offset().top-$('.calculator__steps__step--1').offset().top-60);$('.calculator__steps__step--2').show();$('.calculator__steps__step--3').css('margin-top',$('#calc__form__submit--step2').offset().top-$('.calculator__steps__step--2').offset().top-40);$('.calculator__steps__step--3').show();},20);}
function validateStep1(e){var validated=true;if(!$('input[name="policy__agree"]:checked').length){validated=_validateElement($('input[name="policy__agree"]'),true);}else{$('input[name="strah_company"],input[name="days"],input[name="country"],input[name="contact_email"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});var adults=+$('input[name="adults"]').val()||0;var children=+$('input[name="children"]').val()||0;var children2=+$('input[name="children2"]').val()||0;var elders=+$('input[name="elders"]').val()||0;var elders2=+$('input[name="elders2"]').val()||0;var country=+$('input[name="country_name"]').val();if(adults+children+children2+elders+elders2==0){$('#calc__select-program--toggle').tooltip('show')
$('#calc__select-program--toggle').addClass('not-valid');validated=false;}else{$('#calc__select-program--toggle').tooltip('destroy')
$('#calc__select-program--toggle').removeClass('not-valid');}
var insprice=$('.calculator__form__insurance-price').html();if(insprice=='не страхует'&&(country!="США")){_validateElement($('input[name="strah_company"]'),true);validated=false;}}
return validated;}
function validateStep2(index_to_check){var validated=true;$('.visa2__wrap').each(function(index,el){if(index_to_check!==undefined&&index_to_check!=index){console.log('not this one');return;}
if(validated){$(this).find('input[name="fio[]"],input[name="data-rozhd[]"],input[name="schengen_last_3_years[]"],input[name="last_schengen[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});$('.visa2__uploaders__wrap').eq(index).find('input[name="phone2[]"],input[name="visa_address[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});if($(this).find('input[name="maiden_name_checkbox[]"]:checked').length){var el_validated=_validateElement($(this).find('input[name="maiden_name[]"]'));if(!el_validated)validated=false;}
var country=$('input[name="country_name"]').val();var persontype=$(this).find('input[name="type[]"]').val();var workstatus=$(this).find('input[name="occupation[]"]').val();if(workstatus=='Работаю'){$(this).find('input[name="work_name[]"],input[name="work_title[]"],input[name="work_address[]"],input[name="work_phone[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});}else if(workstatus=='Учусь в ВУЗе'||workstatus=='Учусь в школе'){$(this).find('input[name="study_name[]"],input[name="study_address[]"],input[name="study_phone[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});}
if(persontype<2){$(this).find('input[name="family[]"],input[name="occupation[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});}
if(persontype=='1'){$(this).find('input[name="visa_child_address[]"],input[name="visa_parent_fio1[]"],input[name="visa_parent_address1[]"],input[name="visa_parent_fio2[]"],input[name="visa_parent_address2[]"]').each(function(index,el){var el_validated=_validateElement($(this));if(!el_validated)validated=false;});}
var have_no_docs=$('.visa2__uploaders__wrap').eq(index).find('input[name="have_no_docs[]"]:checked').length;var idc=$('.visa2__uploaders__wrap').eq(index).find('input[name="idc"]').val();if(!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_photo['+idc+'][]"]').length<1){validated=true;}else{$('.visa2__uploaders__wrap').eq(index).find('form[data-input="file_photo[]"]').tooltip('hide').removeClass('not-valid');validated=true;}
if(!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_zagran['+idc+'][]"]').length<1){validated=true;}else{validated=true;}
if(persontype==0&&!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_passport['+idc+'][]"]').length<2){validated=true;}else{validated=true;}
if(country!='Финляндия'&&country!='США'&&country!='Великобритания'&&!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_hotel['+idc+'][]"]').length<1){validated=true;}else{validated=true;}
if(workstatus=='Работаю'||workstatus=='Учусь в ВУЗе'||workstatus=='Учусь в школе'){if(country!='Финляндия'&&!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_work['+idc+'][]"]').length<1){validated=true;}else{validated=true;}}
if(persontype>1){if(!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_birth['+idc+'][]"]').length<1){validated=true;}else{validated=true;}
if(!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_parent['+idc+'][]"]').length<1){validated=true;}else{validated=true;}
if(!have_no_docs&&$('.visa2__uploaders__wrap').eq(index).find('input[name="file_parentviza['+idc+'][]"]').length<1){validated=true;}else{validated=true;}}
if(!validated){$('.visa__tab').eq(index).removeClass('ready');$('.visa__tab').eq(index).click();$('html, body').animate({scrollTop:$("#calc__form__step2__zayaviteli").offset().top-50},600);}else{$('.visa__tab').eq(index).addClass('ready');}}});return validated;}
function validateStep3(){var validated=true;var send_document_type=parseInt($('input[name="send_document_type"]:checked').val());var delivery_type=parseInt($('input[name="delivery_type"]:checked').val());var input_list=[];if(send_document_type==1){input_list.push('input[name="address_list[1][address_from]"]');}
if(delivery_type==1){input_list.push('input[name="address_list[1][address_to]"]');}
if(send_document_type===delivery_type&&send_document_type==2){input_list.push('input[name="address_list[0][office]"]');}
else{if(send_document_type==2){input_list.push('input[name="address_list[2][office_from]"]');}
if(delivery_type==2){input_list.push('input[name="address_list[2][office_to]"]');}}
if(input_list){$.each(input_list,function(el,index){var el_validated=_validateElement($(index));if(!el_validated)validated=false;});}
return validated;}
function prepopulateStep3(){console.log('отобразить всех заявителей и детей');}
function save_step1(){var form1=serializeForm('#calc__form__step1');$.ajax({url:'/backend/ajax/save_step1.php',data:{data:form1,callback:'save_step1_uid'},type:'POST',dataType:'json',success:function(result){if(result.callback){eval(result.callback);}}});}
function save_step1_uid(data){$('input[name="uid"]').val(data.uid);}
function send_to_payment(data){console.log(data); window.location=data.redirect; return true;}
function generate_visa_tab_name(num,type){var num=num+1;if(type===0){var str='анкету '+num+'-го '+'заявителя';}else{var str='анкету '+num+'-го '+'ребенка';}
$('#calc__form__step2__zayaviteli').html(str);}
function generate_visa_tabs(num_zayav,num_detey){var uid='';var nz=['первый','второй','третий','четвертый','пятый','шестой','седьмой','восьмой'];var vizaform=$('.visa2__wrap');vizaform=$("<div class='visa2__wrap'>"+vizaform.clone().html()+"</div>");var vizauploadform=$('.visa2__uploaders__wrap');vizauploadform=$("<div class='visa2__uploaders__wrap'>"+vizauploadform.clone().html()+"</div>");$('.visa2__tabs__toggler').html('');$('.visa2__uploaders__toggler').html('');$('.visa__tabs').html('');var adults=+$('input[name="adults"]').val()||0;var children=+$('input[name="children"]').val()||0;var children2=+$('input[name="children2"]').val()||0;var elders=+$('input[name="elders"]').val()||0;var elders2=+$('input[name="elders2"]').val()||0;for(i=0;i<adults+elders+elders2;i++){$('.visa__tabs').append('<div class="visa__tab" onclick="generate_visa_tab_name('+i+',0)"><i class="ico ico-visa-folder"></i><span>'+nz[i]+' заявитель</span></div>');var viza=vizaform.clone();viza.addClass('adult');viza.append("<input type='hidden' name='type[]' value='0'/>");$('.visa2__tabs__toggler').append(viza);var uplo=vizauploadform.clone();uplo.addClass('adult');uplo.find('input[name="idc"]').val('vzr'+(i+1));uplo.find('input[name="uid"]').val(uid);$('.visa2__uploaders__toggler').append(uplo);}
for(i=0;i<children;i++){$('.visa__tabs').append('<div class="visa__tab" onclick="generate_visa_tab_name('+i+',1)"><i class="ico ico-visa-folder"></i><span>'+nz[i]+' ребенок</span></div>');var viza=vizaform.clone();viza.addClass('child').addClass('adult');viza.append("<input type='hidden' name='type[]' value='1'/>");$('.visa2__tabs__toggler').append(viza);var uplo=vizauploadform.clone();uplo.addClass('child').addClass('adult');uplo.find('input[name="uid"]').val(uid);uplo.find('input[name="idc"]').val('reb'+(i+1));$('.visa2__uploaders__toggler').append(uplo);}
for(i=0;i<children2;i++){$('.visa__tabs').append('<div class="visa__tab" onclick="generate_visa_tab_name('+i+',1)"><i class="ico ico-visa-folder"></i><span>'+nz[i]+' ребенок</span></div>');var viza=vizaform.clone();viza.addClass('child');viza.append("<input type='hidden' name='type[]' value='2'/>");$('.visa2__tabs__toggler').append(viza);var uplo=vizauploadform.clone();uplo.addClass('child');uplo.find('input[name="uid"]').val(uid);uplo.find('input[name="idc"]').val('reb'+(i+1));$('.visa2__uploaders__toggler').append(uplo);}
$('.visa2__wrap').removeClass('active');$('.visa2__uploaders__wrap').removeClass('active');if(adults+children+children2+elders+elders2<2){$('.visa2__wrap').addClass('active');}
$('.dropzone').dropzone({maxFilesize:5000,uploadMultiple:false,addRemoveLinks:true,paramName:'loadfile',url:viza_backend+'view/upload.php',clickable:true,params:{'new':1},success:function(file,response){json=JSON.parse(response);var inputname=$(this.element).data('input');inputname=inputname.replace("[]","["+$(this.element).find('input[name="idc"]').val()+"]")+"[]";$(this.element).parents('.visa2__uploaders').append('<input type="hidden" name="'+inputname+'" value="'+json.filename+'" />');}});}
function init_visa_events(){$(document).on('click','.visa__tab:not(.active)',function(){if($('.visa__tab.active').length){if(!$(this).hasClass('ready')&&!validateStep2($('.visa__tab.active').index())){return false;}}
$(this).addClass('active').siblings().removeClass('active').closest('.row').find('.visa2__wrap').removeClass('active').eq($(this).index()).addClass('active');$('.visa2__uploaders__wrap').removeClass('active').eq($(this).index()).addClass('active');fixFileNumbers();});$(document).on('click','.togable-maden-name',function(){var val=$(this).find('input').val();if(val=="Нет"){$(this).closest('.visa2__wrap').find('.toggle-maden-name').fadeOut('600',function(){initSteps2();});}else if(val=="Да"){$(this).closest('.visa2__wrap').find('.toggle-maden-name').fadeIn('600',function(){initSteps2();});}});$(document).on('click','.togable-occupation .calculator__form__dropdown__custom-select li',function(){var val=$(this).closest('.calculator__form__input').find('input').val();if(val=="Работаю"){$(this).closest('.visa2__wrap').find('.toggle-occupation-work').fadeIn('600',function(){initSteps2();});$(this).closest('.visa2__wrap').find('.toggle-occupation-school').fadeOut('600',function(){initSteps2();});$(this).closest('.togable-occupation').removeClass('calculator__form__input--ico-school');}else if(val=="Учусь в ВУЗе"||val=="Учусь в школе"){$(this).closest('.visa2__wrap').find('.toggle-occupation-school').fadeIn('600',function(){initSteps2();});$(this).closest('.visa2__wrap').find('.toggle-occupation-work').fadeOut('600',function(){initSteps2();});$(this).closest('.togable-occupation').addClass('calculator__form__input--ico-school');}else{$(this).closest('.visa2__wrap').find('.toggle-occupation-work').fadeOut('600',function(){initSteps2();});$(this).closest('.visa2__wrap').find('.toggle-occupation-school').fadeOut('600',function(){initSteps2();});}});$(document).on('click','.togable-have-schengen',function(){var val=$(this).find('input').val();if(val=="Нет"){$(this).closest('.visa2__wrap').find('.toggle-have-schengen').fadeOut('600',function(){initSteps2();});}else if(val=="Да"){$(this).closest('.visa2__wrap').find('.toggle-have-schengen').fadeIn('600',function(){initSteps2();});}});$(document).on('change','input[name="data-rozhd"]',function(){var val=$(this).val();var age=calcAge(val);if(age<18){$('.visa2__wrap.active').addClass('child');$('.visa2__uploaders__wrap.active').addClass('child');}else{$('.visa2__wrap.active').removeClass('child');$('.visa2__uploaders__wrap.active').removeClass('child');}});$(document).on('change','input[name="occupation[]"],input[name="self_or_invite_travel[]"],input[name="visa_stay[]"],input[name="schengen_last_3_years[]"]',function(){checkFileForms();});checkFileForms();}
function calcAge(d){var birthday=+new Date(d.substr(6,4),d.substr(3,2)-1,d.substr(0,2));return~~((Date.now()-birthday)/(31557600000));}
function viza_calc_summ(){var adults=+$('input[name="adults"]').val()||0;var children=+$('input[name="children"]').val()||0;var children2=+$('input[name="children2"]').val()||0;var elders=+$('input[name="elders"]').val()||0;var elders2=+$('input[name="elders2"]').val()||0;var insco=$('input[name="strah_company"]').val();var country=$('input[name="country"]').val();var country_name=$('input[name="country_name"]').val();var days=$('input[name="days"]').val();var viza_service_type=$('input[name="viza_service_type"]:checked').val();var podacha=$('input[name="podacha"]:checked').val();var send_document_type=$('input[name="send_document_type"]:checked').val();var delivery_type=$('input[name="delivery_type"]:checked').val();var pickup_documents=$('input[name="pickup_documents"]:checked').val()?1:0;var promo=$('input[name="promo"]').val();var discount_type=parseInt($('input[name="discount_type"]:checked').val())||0;var discount_data=$('.discount_edit[data-type="'+discount_type+'"] input[name="discount_data"]').val()||'';$('#calc__form__step2 .country, #calc__form__step3 .country').html(encodeHTML(country_name));$('#calc__form__step2 .viza_service_type,#calc__form__step3 .viza_service_type').html($("label[for='"+$('input[name="viza_service_type"]:checked').attr('id')+"']").text());var text_top=[];if(adults+elders+elders2){text_top.push((adults+elders+elders2)+' '+declOfNum((adults+elders+elders2),['взрослый','взрослых','взрослых']));}
if(children+children2){text_top.push((children+children2)+' '+declOfNum((children+children2),['ребенок','детей','детей']));}
$('#calc__form__step2 .viz_num,#calc__form__step3 .viz_num').html(text_top.join(', '));$('#calc__form__step2 .ins_type,#calc__form__step3 .ins_type').html(encodeHTML(insco)+", "+encodeHTML(days)+" дней");$('.visa-step3-insdays').html('Страховка на '+encodeHTML(days)+' дней');if(insco&&country&&days&&(adults||children||children2||elders||elders2)){$.ajax({data:{regionCode:selected_country,strah_company:insco,country:country,country_name:country_name,days:days,document:viza_service_type,pickup_documents:pickup_documents,send_document_type:send_document_type,delivery_type:delivery_type,podacha:podacha,discount_type:discount_type,discount_data:discount_data,adults:adults,children:children,children2:children2,elders:elders,elders2:elders2,n:1},dataType:'json',url:viza_backend+'calc_summ.php',type:'POST',success:function(result){if(result.status==='fail'){alert("Произошла ошибка:\r\n"+result.message);return false;}
$('.calculator__form__insurance-price').parent('div').html(result.ins_price_html);$('.visa-form-choicen__price').html(result.all_price_html);$('.visa-form-choicen ul').html(result.html);$('.visa-form-choicen').fadeIn();$('.discount_block').slideDown(400,function(){initSteps1();});}});}}